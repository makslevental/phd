\begin{figure*}
	\pgfplotstableread[]{figures/registration/sift/subgrad_hists.csv}\subgradhists
	\tikzstyle{every picture}+=[remember picture]
	\tikzset{
		pics/greensquare/.style args={#1/#2/#3}{
				code = {
						\draw[green, line width=.5mm] (#1,#2) rectangle (#1+#3, #2+#3);
					}
			},
		subgradbin/.pic={
				\foreach \i in {0.0, 1.0} {
						\pgfmathsetmacro{\x}{0.5+\i*2*.08825};
						\foreach \j in {0.0, 1.0} {
								\pgfmathsetmacro{\y}{0.5+\j*2*.08825};
								\pic[] {greensquare=\x/\y/2*.08825};
							}
					}
			},
		pics/subgradbins/.style args={#1}{
				code = {
						\foreach \x in {0,1,2,3} {
								\pgfmathtruncatemacro{\angle}{#1+\x*90}
								\pic[rotate around={\angle:(0.5,0.5)}] {subgradbin};
							}
					}
			},
		bert_grads/.pic={
			},
		pics/edgehistogram/.style args={#1/#2}{
				code={
						\begin{axis}[area style, width=2.5cm,height=2.5cm, hide axis, at={(#1cm,#2cm)}]
							\addplot+[ybar interval] plot coordinates {
									(-0.50, 2) (0.5, 4) (1.5, 5) (2.5, 3) (3.5, 2) (4.5, 2) (5.5, 0)
								};
							\path
							\foreach[count=\i from 0] \v in {2, 4, 5, 3, 2, 2} {
									(\i, \v) node[below] {\tiny\v}
								};
						\end{axis}
					}
			},
		pics/randomedgehistogram/.style args={#1/#2}{
				code={
						\begin{axis}[area style, width=2.5cm,height=2.5cm, hide axis, at={(#1cm,#2cm)}]
							%							\pgfmathrandominteger{\na}{3}{4}
							%							\pgfmathrandominteger{\nb}{3}{4};
							%							\pgfmathrandominteger{\nc}{3}{8};
							%							\pgfmathrandominteger{\nd}{3}{8};
							%							\pgfmathrandominteger{\ne}{3}{4};
							%							\pgfmathrandominteger{\nf}{3}{4};
							%							\pgfmathrandominteger{\ng}{3}{4};
							%							\pgfmathrandominteger{\nh}{3}{4};
							\pgfmathtruncatemacro{\rowindex}{#1*4+#2}
							\pgfplotstablegetelem{\rowindex}{[index]0}\of{\subgradhists}\pgfmathtruncatemacro{\na}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]1}\of{\subgradhists}\pgfmathtruncatemacro{\nb}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]2}\of{\subgradhists}\pgfmathtruncatemacro{\nc}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]3}\of{\subgradhists}\pgfmathtruncatemacro{\nd}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]4}\of{\subgradhists}\pgfmathtruncatemacro{\ne}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]5}\of{\subgradhists}\pgfmathtruncatemacro{\nf}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]6}\of{\subgradhists}\pgfmathtruncatemacro{\ng}{\pgfplotsretval};
							\pgfplotstablegetelem{\rowindex}{[index]7}\of{\subgradhists}\pgfmathtruncatemacro{\nh}{\pgfplotsretval};
							\addplot+[ybar interval] plot coordinates {
									(-0.50, \na)
									(0.5, \nb)
									(1.5, \nc)
									(2.5, \nd)
									(3.5, \ne)
									(4.5, \nf)
									(5.5, \ng)
									(6.5, \nh)
									(7.5, 0)
								};
							\path
							\foreach[count=\i from 0] \v in {\na, \nb, \nc, \nd, \ne, \nf, \ng, \nh} {
									(\i, \v) node[below] {\scalebox{.3}{\v}}
								};
							\coordinate (hist-#1#2) at (5,-3);
						\end{axis}
					}
			},
		redarrow/.style={
				-latex,red,thick,solid
			},
		array/.style={
				draw,
				minimum width=2em,
				minimum height=2em,
				outer sep=0pt
			},
		dot/.style = {
				circle,
				fill,
				minimum size=#1,
				inner sep=0pt,
				outer sep=0pt
			},
		dot/.default = 6pt  % size of the circle diameter
	}
	\newcommand*{\siftwidth}{.5\linewidth}
	\newcommand*{\length}{sqrt((2.*x^2+2.*y^2)^2 + (8.*x^2*y^2)^2 )}
	\pgfplotsset{ % Define a common style, so we don't repeat ourselves
		dominantorientationaxis/.style={
				enlargelimits = false ,
				view={0}{90},
				xmin=0, xmax=1, ymin=0, ymax=1,
				ytick distance=1/16,
				xtick distance=1/16,
				axis equal image, grid=both,
				minor grid style={black},
				major grid style={black},
				axis equal image,
				samples=16
			},
		dominantorientationvectors/.style={
				domain=1/32:31/32,
				black,
				quiver={
						u={(2.*x^2+2.*y^2)/(2*\length)},
						v={8.*x^2*y^2/(2*\length)},
						scale arrows=0.2},
				-latex
			}
	}
	\pgfplotsset{ticks=none}
	\begin{subfigure}{\siftwidth}
		\centering
		\begin{tikzpicture}
			\begin{axis}[dominantorientationaxis]
				\addplot[on layer=axis background] graphics[xmin=0, xmax=1, ymin=0, ymax=1]
					{figures/registration/sift/bert_keypoint.png};
				\addplot[redarrow,quiver={u=\thisrow{u},v=\thisrow{v}}] table {figures/registration/sift/grads.csv};
				\node[dot=5pt](keypoint) at (0.5,0.5) {};
			\end{axis}
			\node (keyp) at (4,6.5) {Keypoint};
			\draw[redarrow] (keyp)--(keypoint);
		\end{tikzpicture}
		\caption{Keypoint neighborhood} \label{fig:1a}
	\end{subfigure}
	\pgfmathsetmacro{\rot}{54}
	\pgfmathsetmacro{\br}{sqrt(2)*.5/2}
	\begin{subfigure}{\siftwidth}
		\centering
		\begin{tikzpicture}
			\begin{axis}[dominantorientationaxis, set layers]
				\addplot[on layer=axis background] graphics[xmin=0, xmax=1, ymin=0, ymax=1]
					{figures/registration/sift/bert_keypoint.png};
				\addplot[redarrow,quiver={u=\thisrow{u},v=\thisrow{v}}] table {figures/registration/sift/grads.csv};
				\node[dot=5pt](keypoint) at (0.5,0.5) {};

				\draw (0.5, 0.5) circle [blue, radius=.5];
				\pic[rotate around={\rot:(0.5,0.5)}] {greensquare=.1464/.1464/.707};
				\draw[line width=2pt,red,-latex](.5,.5)--(.5+0.3579, 1);
				\coordinate (gausscircle) at (.75,.25);
				\coordinate (dominantgrad) at (.5+0.25,.5+.35);
				\coordinate (gradsquare) at (.5-\br,.5+\br);
			\end{axis}
			\node (gausswin) at (5,-0.5) {Gradient Window};
			\node (gradwin) at (1,6.5) {Gaussian Window};
			\node (domin) at (4,6.5) {Majority Gradient};
			\draw[redarrow] (gausswin)--(gausscircle);
			\draw[redarrow] (gradwin)--(gradsquare);
			\draw[redarrow] (domin)--(dominantgrad);
		\end{tikzpicture}
		\caption{Oriented and filterd keypoint gradient neigbhorhood} \label{fig:1b}
	\end{subfigure}
	\vskip\baselineskip
	\begin{subfigure}{\siftwidth}
		\centering

		\begin{tikzpicture}
			\begin{scope}[rotate=\rot,transform shape,local bounding box=scope1]
				\clip[](1.95,1.99) rectangle (6.0,6.03);
				\begin{axis}[dominantorientationaxis, rotate around={-\rot:(.5,.5)}, grid=none]
					%					\addplot3[dominantorientationvectors] {0};
					\addplot[on layer=axis background] graphics[xmin=0, xmax=1, ymin=0, ymax=1]
						{figures/registration/sift/bert_keypoint.png};
					\addplot[redarrow,quiver={u=\thisrow{u},v=\thisrow{v}}] table {figures/registration/sift/grads.csv};
					\node[dot=5pt](keypoint) at (0.5,0.5) {};

					\pic[] {subgradbins=\rot};
					\coordinate (gradbin) at (0,0);
					\node[dot=5pt](keypoint) at (0.5,0.5) {};
				\end{axis}
			\end{scope}
			\begin{scope}[shift={($(scope1.south)-(0,1cm)$)}]
				\node (gradb) at (0,0) {Gradient bin};
				\draw[redarrow] (gradb)--(gradbin);
			\end{scope}
		\end{tikzpicture}
		\caption{16 Keypoint neigbhorhood gradient bins} \label{fig:1c}
	\end{subfigure}
	\readdef{figures/registration/sift/subgrad_hists.csv}\namedata
	\readarray\namedata\names[-,\ncols]
	\begin{subfigure}{\siftwidth}
		\centering
		\begin{tikzpicture}
			\pgfmathtruncatemacro{\kmax}{div(3.0,1.0)}
			\begin{scope}[rotate=\rot-90,transform shape,local bounding box=scope1]
				\foreach \i [evaluate=\i as \x using \i*1.0] in {0,...,\kmax}{
						\foreach \j [evaluate=\j as \x using \j*1.0] in {0,...,\kmax}{
								\pic {greensquare=\i/\j/1.0};
								\pgfmathtruncatemacro{\n}{\i*4+\j};
								\pic {randomedgehistogram=\i/\j};
							}
					}
				\node[dot=5pt](keypoint) at (2.0,2.0) {};
				\coordinate (histbin) at (0.5,2.5);
			\end{scope}
			\node (histb) at (3,3.5) {Histogram of gradient orientations};
			\draw[redarrow] (histb)--(histbin);
			\begin{scope}[shift={($(scope1.south)-(0,1cm)$)}]
				\matrix (A) [matrix of math nodes, nodes={array, anchor=center}, column sep=-\pgflinewidth]
				{d_0,\dots,d_7 & d_8,\dots,d_{15} & \cdots\cdots\cdots & d_{120},\dots,d_{127} \\};
				\draw[decorate,decoration={brace, amplitude=10pt, raise=5pt, mirror}]
				(A-1-1.south west) to node[black,midway,below= 15pt] {$16 \times 8$ entries} (A-1-4.south east);%
				\draw[redarrow] (hist-00) -- (A-1-1);
				\draw[redarrow] (hist-10) -- (A-1-2);
				\draw[redarrow] (hist-20) -- (A-1-3);
				\draw[redarrow] (hist-30) -- (A-1-3);
				\foreach \i in {1,...,2}{
						\foreach \j in {0,...,3}{
								\draw[redarrow] (hist-\j\i) -- (A-1-3);
							}
					}
				\draw[redarrow] (hist-03) -- (A-1-3);
				\draw[redarrow] (hist-13) -- (A-1-3);
				\draw[redarrow] (hist-23) -- (A-1-3);
				\draw[redarrow] (hist-33) -- (A-1-4);
			\end{scope}
		\end{tikzpicture}
		\begin{tikzpicture}

		\end{tikzpicture}
		\begin{tikzpicture}[overlay]
		\end{tikzpicture}
		\caption{Histogram of gradient orientations descriptor} \label{fig:1d}
	\end{subfigure}
	%	\caption{A figure that contains three subfigures} \label{fig:1}
\end{figure*}

